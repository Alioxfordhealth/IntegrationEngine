# Rudimentary Extract of codemaps from www.hl7.org using WebRequest and JSON querying - Note that this doesn't pull all of the codemaps, just the ones that follow the URI

$codepages = "0001", "0364",	"0203",	"0508",	"0128",	"0436",	"0269",	"0669",	"0074",	"0398",	"0236",	"0554",	"0163",	"0480",	"0311",	"0881",	"0127",
"0002",	"0365",	"0204",	"0510",	"0130",	"0437",	"0270",	"0682",	"0076",	"0401",	"0237",	"0555",	"0164",	"0482",	"0315",	"0882",	"0435",
"0003",	"0366",	"0205",	"0511",	"0131",	"0438",	"0271",	"0702",	"0078",	"0402",	"0238",	"0556",	"0165",	"0483",	"0316",	"0894",	"0268",
"0004",	"0367",	"0206",	"0513",	"0133",	"0440",	"0272",	"0717",	"0080",	"0403",	"0239",	"0557",	"0166",	"0484",	"0317",	"0895",	"0667",
"0005",	"0368",	"0207",	"0514",	"0135",	"0441",	"0273",	"0719",	"0083",	"0404",	"0240",	"0558",	"0167",	"0485",	"0321",	"0904",	"0357",
"0006",	"0369",	"0208",	"0516",	"0136",	"0442",	"0275",	"0725",	"0085",	"0406",	"0241",	"0559",	"0168",	"0487",	"0322",	"0905",	"0360",
"0007",	"0370",	"0209",	"0517",	"0137",	"0443",	"0276",	"0728",	"0091",	"0409",	"0242",	"0561",	"0169",	"0488",	"0323",	"0906",	"0356",
"0008",	"0371",	"0210",	"0518",	"0140",	"0444",	"0277",	"0731",	"0092",	"0411",	"0243",	"0562",	"0170",	"0489",	"0324",	"0907",	"0359",
"0009",	"0372",	"0211",	"0520",	"0141",	"0445",	"0278",	"0734",	"0098",	"0415",	"0247",	"0564",	"0173",	"0490",	"0325",	"0909",	
"0012",	"0373",	"0213",	"0523",	"0142",	"0450",	"0279",	"0739",	"0100",	"0416",	"0248",	"0565",	"0174",	"0491",	"0326",	"0912",	
"0017",	"0374",	"0214",	"0524",	"0144",	"0455",	"0280",	"0742",	"0102",	"0417",	"0250",	"0566",	"0175",	"0492",	"0329",	"0914",	
"0023",	"0375",	"0215",	"0527",	"0145",	"0456",	"0281",	"0749",	"0103",	"0418",	"0251",	"0569",	"0177",	"0493",	"0330",	"0916",	
"0027",	"0376",	"0216",	"0528",	"0146",	"0457",	"0282",	"0755",	"0104",	"0421",	"0252",	"0570",	"0178",	"0494",	"0331",	"0917",	
"0033",	"0377",	"0217",	"0529",	"0147",	"0459",	"0283",	"0757",	"0105",	"0422",	"0253",	"0571",	"0179",	"0495",	"0332",	"0918",	
"0034",	"0383",	"0220",	"0530",	"0148",	"0460",	"0284",	"0759",	"0106",	"0423",	"0254",	"0572",	"0180",	"0496",	"0334",	"0919",	
"0038",	"0384",	"0223",	"0532",	"0149",	"0465",	"0286",	"0761",	"0107",	"0424",	"0255",	"0615",	"0181",	"0497",	"0335",	"0920",	
"0043",	"0387",	"0224",	"0534",	"0150",	"0466",	"0287",	"0763",	"0108",	"0425",	"0256",	"0616",	"0183",	"0498",	"0336",	"0921",	
"0048",	"0388",	"0225",	"0535",	"0153",	"0468",	"0290",	"0776",	"0109",	"0426",	"0257",	"0617",	"0185",	"0499",	"0337",	"0922",	
"0052",	"0389",	"0227",	"0536",	"0155",	"0469",	"0291",	"0778",	"0116",	"0427",	"0258",	"0618",	"0187",	"0500",	"0338",	"0923",	
"0061",	"0391",	"0228",	"0538",	"0156",	"0470",	"0292",	"0790",	"0119",	"0428",	"0259",	"0625",	"0189",	"0501",	"0339",	"0924",	
"0062",	"0392",	"0229",	"0540",	"0157",	"0472",	"0294",	"0793",	"0121",	"0429",	"0260",	"0634",	"0190",	"0502",	"0344",	"0925",	
"0063",	"0393",	"0230",	"0544",	"0158",	"0473",	"0298",	"0806",	"0122",	"0430",	"0261",	"0642",	"0191",	"0503",	"0350",	"0926",	
"0065",	"0394",	"0231",	"0547",	"0159",	"0474",	"0299",	"0818",	"0123",	"0431",	"0262",	"0651",	"0193",	"0504",	"0351",	"0927",	
"0066",	"0395",	"0232",	"0548",	"0160",	"0475",	"0301",	"0834",	"0124",	"0432",	"0263",	"0653",	"0200",	"0505",	"0353",	"0933",	
"0069",	"0396",	"0234",	"0550",	"0161",	"0477",	"0305",	"0868",	"0125",	"0433",	"0265",	"0657",	"0201",	"0506",	"0354",	"0935",	
"0070",	"0397",	"0235",	"0553",	"0162",	"0478",	"0309",	"0871",	"0126",	"0434",	"0267",	"0659",	"0202",	"0507",	"0355",	"4000";

foreach ($cp in $codepages) {

    Write-Output $cp;

    $uri = "http://www.hl7.org/fhir/v2/$cp/v2-$cp.cs.json";

    $result = Invoke-WebRequest -UseBasicParsing -Uri $uri;

    $res = $result.Content | ConvertFrom-Json | Select-Object id, description;

    $TabRes = $result.Content | ConvertFrom-Json | Select-Object -ExpandProperty concept | Select-Object @{Expression = {$res.description}; Label = "Description"}, @{Expression = {$res.id.substring(3)}; Label = "ID"}, code, display;

    $TabRes | Export-Csv -Path "C:\Users\nicholas.walne\Desktop\HL7\codepage_$cp.csv"
}

